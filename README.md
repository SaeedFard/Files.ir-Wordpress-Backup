# Files.ir Wordpress Backup

افزونهٔ وردپرس برای **بکاپ‌گیری خودکار (روزانه/هفتگی)** از **دیتابیس** و **فایل‌های مهم** و **آپلود مستقیم روی Files.ir** از طریق API.  
دارای Worker URL (برای کرانِ سیستمی)، هدف‌گذاری پوشه (با `parentId`/`relativePath`)، مدیریت لاگ و نگه‌داری نسخه‌های محلی.

> **Author:** Saeed Fard — <https://github.com/SaeedFard>  
> **Requires:** WordPress ≥ 5.6, PHP ≥ 7.4

---

## ویژگی‌ها

- بکاپ **دیتابیس** (mysqldump یا خروجی PHP در صورت نبودن mysqldump)
- بکاپ **فایل‌ها** (ZIP یا TAR.GZ) با:
  - مسیرهای قابل انتخاب (uploads/themes/plugins …)
  - امکان **شامل کردن** `wp-config.php` و `.htaccess`
  - **الگوهای حذف** (Glob: `*` و `?`)
- زمان‌بندی **روزانه/هفتگی** با ساعت/دقیقه دلخواه
- آپلود مستقیم به Files.ir (Authorization: **Bearer** token)
- هدف‌گذاری پوشهٔ مقصد با `parentId` یا `relativePath`
- **Worker URL** (اجرای مستقیم بدون WP-Cron؛ مناسب cronjob سرور)
- نگه‌داری **نسخه‌های محلی** + **پاک‌سازی خودکار** (Retention)
- مدیریت لاگ داخل پیشخوان (نمایش/پاک‌سازی/حذف لاگ)
- حالت‌های سازگاری برای سرورهای حساس به multipart/Expect

---

## 🧩 پیش‌نیازها

- PHP 7.4+  
- WordPress 5.6+  
- برای ZIP: افزونهٔ PHP `zip` (کلاس `ZipArchive`)  
- برای TAR.GZ (اختیاری): `PharData` و `phar.readonly = Off` (در نبودش، **خودکار** به ZIP سوئیچ می‌شود)

---

## 🚀 شروع سریع

1. فایل ZIP افزونه را نصب/فعال کنید.  
2. به **تنظیمات → Files.ir Wordpress Backup** بروید.  
3. قسمت **API** را این‌طور پر کنید:
   - **Endpoint:** `https://my.files.ir/api/v1/uploads`
   - **Header:** `Authorization`
   - **Prefix:** `Bearer `
   - **Token:** توکن Files.ir
   - **Multipart field:** `file`
4. (اختیاری) **فیلدهای اضافه (JSON)** برای هدف‌گذاری پوشه:  
   ```json
   { "parentId": 11848 }
   ```
   یا اگر می‌خواهید نام فایل روی مسیر خاصی بنشیند:
   ```json
   { "relativePath": "wp-backups/my-site/db-20250101.sql.gz" }
   ```
5. زمان‌بندی را روی **روزانه** یا **هفتگی** تنظیم کنید و ذخیره بزنید.  
6. از دکمهٔ «اجرای در پس‌زمینه» برای تست آنی استفاده کنید.

> پلاگین به‌صورت خودکار فیلدهای اطلاعاتی `site`, `db`, `created_at` را همراه فایل می‌فرستد.

---

## 🗂️ پیدا کردن `parentId` فولدر مقصد

برای آپلود در پوشهٔ خاص، باید **ID** آن فولدر را بدانید:

- از API Files.ir:  
  ```
  GET /api/v1/drive/file-entries?type=folder&query=test&perPage=50
  ```
  در نتیجهٔ JSON، فیلد `id` همان `parentId` است.  
- یا در UI Files.ir، گاهی `id` در URL/متادیتا قابل مشاهده است.

**نکته:** اگر `relativePath` بدهید، نیازی به `parentId` نیست.

---

## ⏱️ کران و اجرای پس‌زمینه

- وردپرس به‌شکل پیش‌فرض از **WP-Cron** استفاده می‌کند (وابسته به بازدید).  
- برای اجراهای دقیق و مستقل از ترافیک، از **Worker URL** استفاده کنید:
  - آدرس Worker و **کلید مخفی** در صفحهٔ تنظیمات نمایش داده می‌شود.
  - همان URL را در cron سرور صدا بزنید (هر روز/ساعت …).
- دکمه‌های مفید:
  - «اجرای در پس‌زمینه (WP-Cron)»
  - «اجرای مستقیم — بدون WP-Cron»
  - «تست آپلود کوچک»

---

## 🧰 تنظیمات فایل‌ها

- **شامل‌ها** (relative به ریشهٔ وردپرس): هر خط یک مسیر، مثل:
  ```
  wp-content/uploads
  wp-content/themes
  wp-content/plugins
  ```
- **حذف‌ها**: الگوی Glob (`cache`, `*.log`, `node_modules`، …).  
- **فرمت آرشیو**: ZIP (پیش‌فرض) یا TAR.GZ (در دسترس بودن PharData لازم است).

---

## 🗃️ نگه‌داری محلی (Retention)

- اگر «نگه داشتن کپی محلی» فعال باشد، افزونه N نسخهٔ آخر از فایل‌های `.sql.gz` و آرشیو فایل‌ها (`.zip`/`.tar.gz`) را در:
  ```
  wp-content/uploads/files-ir-wordpress-backup/
  ```
  نگه می‌دارد و بقیه را حذف می‌کند.  
- اگر پوشهٔ جدید وجود نداشته باشد، افزونه به‌طور هوشمند از پوشهٔ قدیمی `files-db-uploader/` استفاده می‌کند.

---

## 🔐 نکات امنیتی

- **کلید مخفی Worker** را عمومی نکنید. در صورت لزوم از دکمهٔ «تولید کلید جدید» استفاده کنید.  
- توکن Files.ir را فقط در سرور مطمئن نگه دارید.  
- اگر آدرس Worker را در cron می‌گذارید، مطمئن شوید به‌صورت HTTPS و با کلید درست است.

---

## 🧪 خطاهای رایج و راه‌حل‌ها

| پیام | دلیل محتمل | راهکار |
|---|---|---|
| **405 Method Not Allowed** | Endpoint اشتباه (`/api/v1/uploads` صحیح است) یا روش ناصحیح | آدرس و متد را چک کنید (POST/PUT) |
| **401/403** | هدر `Authorization`/توکن نادرست | مقدار `Bearer {TOKEN}` را بررسی کنید |
| **500 از Files.ir** | محدودیت یا خطای سمت سرور | بعداً دوباره تلاش کنید؛ اندازهٔ فایل/فیلدها را بازبینی کنید |
| **Request Timeout** | زمان اجرای طولانی (آرشیو بزرگ) | اجرای پس‌زمینه/Worker و افزایش timeout |
| **PharData در دسترس نیست** | `phar.readonly=On` | از ZIP استفاده کنید (افزونه خودکار سوئیچ می‌کند) |
| **WP-Cron اجرا نمی‌شود** | ترافیک کم یا `DISABLE_WP_CRON` | از Worker URL یا cron سیستم استفاده کنید |

لاگ‌ها در مسیر زیر ذخیره می‌شود و از همان‌جا در پیشخوان قابل پاک‌سازی/حذف است:  
`wp-content/uploads/files-ir-wordpress-backup/logs.txt`

---

## 🛠️ توسعه

- اسلاگ افزونه: `files-ir-wordpress-backup`  
- تنظیمات ذخیره می‌شود در: `fdu_settings`  
- رویدادهای کران: `fdu_cron_upload_event`, `fdu_async_run_event`  
- تغییر نام/اسلاگ از نسخه‌های قدیمی (Files DB Uploader) **با مهاجرت امن** انجام شده و تنظیمات قبلی حفظ می‌شود.

Pull Request‌ها و Issueها خوش‌آمدند ✌️

---

## 📜 مجوز

GPL-2.0-or-later — ببین: <https://www.gnu.org/licenses/gpl-2.0.html>

---

## 🗓️ تغییرات

- **1.0.2** – لینک «تنظیمات» در لیست افزونه‌ها (Plugins)  
- **1.0.1** – اصلاح تایپی در لاگ‌ها (`spawn_cron` / `doing_wp_cron`)  
- **1.0.0** – تغییر اسلاگ به `files-ir-wordpress-backup` با حفظ کامل تنظیمات و کران  
- **0.3.x** – اضافه شدن Worker URL، مدیریت لاگ، بکاپ فایل‌ها، و بهبودهای API
